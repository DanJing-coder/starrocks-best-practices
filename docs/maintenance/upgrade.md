# 集群升降级 (SOP)

对 StarRocks 集群进行版本升级是获取新功能、性能优化和 Bug 修复的重要途径。本章将提供标准的集群升降级操作流程（SOP），帮助您安全、平滑地完成版本变更。

> **注意：**
> 本章内容为标准的升降级操作流程总结。关于特定版本的详细升级步骤、兼容性说明和注意事项，请务必参考 StarRocks 官方文档：
> *   **升级文档:** [https://docs.starrocks.io/zh/docs/deployment/upgrade/](https://docs.starrocks.io/zh/docs/deployment/upgrade/)
> *   **降级文档:** [https://docs.starrocks.io/zh/docs/deployment/downgrade/](https://docs.starrocks.io/zh/docs/deployment/downgrade/)

## 1. 升降级前置检查与最佳实践

在执行任何升降级操作之前，请务必遵循以下检查清单和实践建议：

- [ ] **详细阅读版本说明 (Release Notes):** 在升级前，务必仔细阅读目标版本的 Release Notes 和 官方提供的变更注意事项，重点关注 **"不兼容变更"**、**"重要特性"** 和 **"废弃功能"** 部分。
- [ ] **备份元数据:** 在任何升级操作开始前，务必对 FE Master 节点的元数据目录 (`meta_dir`) 进行物理备份。这是在发生灾难性问题时最后的恢复手段。
- [ ] **在预发/测试环境充分验证:** **严禁**在未经验证的情况下直接升级生产环境。请务必在与生产环境配置相似的预发或测试环境中完整地执行一遍升级流程，并验证核心业务的查询和导入功能是否正常。
- [ ] **选择业务低峰期操作:** 升降级会涉及节点重启，虽然滚动升级对业务影响较小，但仍建议在业务负载最低的时间段进行，以减小潜在风险。
- [ ] **检查集群健康状态:** 升级前，确保集群处于健康状态。
    ```sql
    -- 检查 BE/FE 节点状态，确保所有节点 Alive
    SHOW BACKENDS;
    SHOW FRONTENDS;

    -- 检查 Tablet 健康状态，确保没有 unhealthy 的副本
    SHOW PROC '/statistic';
    ```
    如果存在不健康的节点或副本，请先处理完毕再进行升级。

## 2. 滚动升级 (推荐)

滚动升级是推荐的升级方式，它通过逐个重启节点来完成升级，可以保证集群在整个升级过程中服务不中断，对业务基本无感。

**升级顺序：BE -> FE**

### 2.1 升级所有 BE 节点

1.  **下载并解压新版本:** 在任一节点下载并解压新版本的 StarRocks 安装包。
2.  **逐个升级 BE:** 对集群中的**每一个** BE 节点，执行以下操作：
    a.  将新版本安装包中的 `be/lib/` 目录完整地拷贝并覆盖当前节点的 `be/lib/` 目录。

        ```bash
        # 假设新版本目录为 new_starrocks_version/
        # 假设当前 BE 部署目录为 /path/to/starrocks/be/
        cp -rf /path/to/new_starrocks_version/be/lib/* /path/to/starrocks/be/lib/
        ```
    
    b.  停止当前 BE 进程。
    
        ```bash
        cd /path/to/starrocks/be/
        ./bin/stop_be.sh
        ```
    
    c.  启动当前 BE 进程。
    
        ```bash
        ./bin/start_be.sh --daemon
        ```
    
    d.  **验证节点:** 连接到 FE，执行 `SHOW BACKENDS;`，等待该节点的 `Alive` 状态变为 `true`，并确认其 `Version` 字段已更新为目标版本。

3.  **确保所有 BE 升级完成:** 重复以上步骤，直到所有 BE 节点都已成功升级并恢复在线状态。

### 2.2 升级所有 FE 节点

FE 节点的升级顺序至关重要，必须遵循 **Observer -> Follower -> Master** 的顺序。

1.  **识别 FE 角色:** 执行 `SHOW FRONTENDS;`，根据 `Role` 字段识别出所有 FE 节点的角色（Master, Follower, Observer）。
2.  **升级所有 Observer 节点:** 对**每一个** Observer 节点，执行以下操作：
    a.  将新版本安装包中的 `fe/lib/` 目录完整地拷贝并覆盖当前节点的 `fe/lib/` 目录。
    b.  停止 FE 进程。
    c.  启动 FE 进程。
    d.  验证节点：执行 `SHOW FRONTENDS;`，确认该节点的 `Alive` 状态为 `true`，`Version` 已更新。
3.  **升级所有 Follower 节点:** 对**每一个** Follower 节点，重复上述 Observer 的升级步骤。
4.  **升级 Master 节点:**
    a.  对当前的 Master 节点执行升级操作（替换 `lib` 目录，停止进程）。
    b.  停止 Master 节点后，集群会自动进行选举，某个 Follower 节点会成为新的 Master。这个过程通常在 10 秒内完成。
    c.  启动原来的 Master 节点，它将作为 Follower 角色加入集群。
    d.  **最终验证:** 再次执行 `SHOW FRONTENDS;`，确认所有 FE 节点的 `Alive` 状态均为 `true`，并且 `Version` 都已更新为目标版本。

## 3. 停机升级

当遇到无法进行滚动升级的重大版本变更（通常在 Release Notes 中会明确指出），或者希望在最短时间内完成升级时，可以选择停机升级。

1.  **通知业务方:** 停机升级会导致集群在一段时间内完全不可用，务必提前与业务方沟通并获得许可。
2.  **备份元数据:** 再次强调，在停机前务必备份 Master FE 的元数据。
3.  **停止整个集群:**
    a.  停止所有 BE 节点的进程。
    b.  停止所有 FE 节点的进程。
4.  **替换所有节点文件:**
    a.  在所有 BE 节点上，用新版本的 `be/lib/` 覆盖旧目录。
    b.  在所有 FE 节点上，用新版本的 `fe/lib/` 覆盖旧目录。
5.  **启动整个集群:**
    a.  启动所有 FE 节点的进程。
    b.  启动所有 BE 节点的进程。
6.  **验证集群:**
    a.  执行 `SHOW FRONTENDS;` 和 `SHOW BACKENDS;`，确认所有节点都已正常启动并加入集群。
    b.  检查集群健康状态。

## 4. 降级与回滚

> **严重警告：** 降级是**极高风险**的操作，StarRocks **不承诺**跨版本的降级兼容性，尤其是涉及到元数据格式变更的版本。降级可能导致元数据损坏、数据丢失甚至集群无法启动。**除非万不得已，否则不要尝试降级。**

如果升级后遇到严重问题，且无法通过其他方式解决，可以考虑回滚到升级前的版本。

### 4.1 滚动回滚

如果升级过程是滚动的，可以尝试以相反的顺序进行滚动回滚。

**回滚顺序：FE -> BE**

1.  **回滚 FE 节点:** 按照 **Master -> Follower -> Observer** 的顺序，逐个停止 FE 节点，用旧版本的 `fe/lib/` 目录覆盖，然后重启。
2.  **回滚 BE 节点:** 逐个停止 BE 节点，用旧版本的 `be/lib/` 目录覆盖，然后重启。

### 4.2 使用元数据备份恢复

如果滚动回滚失败，或集群无法正常工作，最后的手段是使用元数据备份进行恢复。

1.  **停止整个集群。**
2.  清空所有 FE 节点的元数据目录 (`meta_dir`)。
3.  将升级前备份的元数据拷贝到原 Master FE 节点的 `meta_dir` 目录下。
4.  在所有节点上，将 `lib` 目录恢复为旧版本。
5.  **（关键）** 仅启动原 Master FE 节点。
6.  使用 `ALTER SYSTEM ADD FOLLOWER/OBSERVER` 命令，将其他 FE 节点重新加入集群。
7.  启动所有 BE 节点。

> **数据丢失风险：** 使用元数据备份恢复，将丢失从备份时间点到恢复时间点之间所有的数据变更（包括数据导入和 Schema Change）。

## 5. 升级后检查

- **功能验证:** 运行核心业务的代表性查询，验证其功能和性能是否符合预期。
- **监控观察:** 密切关注 Grafana 监控大盘，检查集群的 CPU、内存、I/O、查询延迟（QPS/Latency）等指标是否正常。
- **日志检查:** 检查 `fe.log` 和 `be.INFO` 日志，确认没有异常的错误或警告信息。