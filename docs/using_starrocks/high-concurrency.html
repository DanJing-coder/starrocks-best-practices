<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-using_starrocks/high-concurrency" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">高并发场景最佳实践 | StarRocks 最佳实践手册</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://danjing-coder.github.io/docs/using_starrocks/high-concurrency"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="高并发场景最佳实践 | StarRocks 最佳实践手册"><meta data-rh="true" name="description" content="在高并发场景下（例如，面向大量用户的在线报表、实时看板、高 QPS 的 API 查询服务），对 StarRocks 的查询响应时间 (Latency) 和吞吐量 (QPS) 有着极高的要求。本章将系统性地介绍如何通过数据建模、物化视图、架构设计和查询优化等一系列手段，来应对高并发场景的挑战。"><meta data-rh="true" property="og:description" content="在高并发场景下（例如，面向大量用户的在线报表、实时看板、高 QPS 的 API 查询服务），对 StarRocks 的查询响应时间 (Latency) 和吞吐量 (QPS) 有着极高的要求。本章将系统性地介绍如何通过数据建模、物化视图、架构设计和查询优化等一系列手段，来应对高并发场景的挑战。"><link data-rh="true" rel="canonical" href="https://danjing-coder.github.io/docs/using_starrocks/high-concurrency"><link data-rh="true" rel="alternate" href="https://danjing-coder.github.io/docs/using_starrocks/high-concurrency" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://danjing-coder.github.io/docs/using_starrocks/high-concurrency" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"使用与开发","item":"https://danjing-coder.github.io/docs/using_starrocks/"},{"@type":"ListItem","position":2,"name":"高并发场景最佳实践","item":"https://danjing-coder.github.io/docs/using_starrocks/high-concurrency"}]}</script><link rel="stylesheet" href="/assets/css/styles.c70b19cb.css">
<script src="/assets/js/runtime~main.92182bdd.js" defer="defer"></script>
<script src="/assets/js/main.d55bee29.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">StarRocks 文档</b></a><a class="navbar__item navbar__link" href="/docs/intro">文档</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">intro</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">StarRocks 最佳实践指南</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/using_starrocks/cluster-planning">最佳实践</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/using_starrocks/cluster-planning">规划与部署</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/using_starrocks">使用与开发</a><button aria-label="折叠侧边栏分类 &#x27;使用与开发&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_starrocks/onboarding">StarRocks 业务接入方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_starrocks/modeling">数据建模</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_starrocks/connector">集群接入与数据导入</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_starrocks/usage">集群使用规范</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_starrocks/materialized_view">StarRocks 最佳实践之物化视图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_starrocks/configuration">集群配置</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_starrocks/etl-processing">ETL/ELT 场景最佳实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/using_starrocks/real-time-analytics">实时分析场景最佳实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/using_starrocks/high-concurrency">高并发场景最佳实践</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/Monitor">运维与监控</a><button aria-label="展开侧边栏分类 &#x27;运维与监控&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/troubleshooting">故障处理</a><button aria-label="展开侧边栏分类 &#x27;故障处理&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/governance">集群治理</a><button aria-label="展开侧边栏分类 &#x27;集群治理&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/docs/maintenance">集群管理</a><button aria-label="展开侧边栏分类 &#x27;集群管理&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/principles">StarRocks 原理</a><button aria-label="展开侧边栏分类 &#x27;StarRocks 原理&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><span class="breadcrumbs__link">最佳实践</span></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/using_starrocks"><span>使用与开发</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">高并发场景最佳实践</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>高并发场景最佳实践</h1></header>
<p>在高并发场景下（例如，面向大量用户的在线报表、实时看板、高 QPS 的 API 查询服务），对 StarRocks 的查询响应时间 (Latency) 和吞吐量 (QPS) 有着极高的要求。本章将系统性地介绍如何通过数据建模、物化视图、架构设计和查询优化等一系列手段，来应对高并发场景的挑战。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-核心思想减少计算减少-io">1. 核心思想：减少计算，减少 I/O<a href="#1-核心思想减少计算减少-io" class="hash-link" aria-label="1. 核心思想：减少计算，减少 I/O的直接链接" title="1. 核心思想：减少计算，减少 I/O的直接链接">​</a></h2>
<p>应对高并发的核心思想是在查询执行的每个环节都尽可能地减少计算量和 I/O 开销，或者直接跳过计算。</p>
<ul>
<li><strong>减少 I/O:</strong> 通过分区裁剪、分桶裁剪、前缀索引等方式，在物理层面读取最少的数据。</li>
<li><strong>减少计算:</strong> 通过预聚合（物化视图）、避免运行时函数、高效算子等方式，在计算层面执行最少的操作。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-数据建模奠定高性能基石">2. 数据建模：奠定高性能基石<a href="#2-数据建模奠定高性能基石" class="hash-link" aria-label="2. 数据建模：奠定高性能基石的直接链接" title="2. 数据建模：奠定高性能基石的直接链接">​</a></h2>
<p>一个优秀的数据模型是实现高并发查询的根本。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-分区分桶与排序键的协同作用">2.1 分区、分桶与排序键的协同作用<a href="#21-分区分桶与排序键的协同作用" class="hash-link" aria-label="2.1 分区、分桶与排序键的协同作用的直接链接" title="2.1 分区、分桶与排序键的协同作用的直接链接">​</a></h3>
<ul>
<li>
<p><strong>分区键 (Partition Key):</strong></p>
<ul>
<li><strong>目的:</strong> 加速时间范围过滤，管理数据生命周期。</li>
<li><strong>实践:</strong> 必须使用时间列作为分区键。在查询时，务必在 <code>WHERE</code> 条件中带上分区键的范围过滤，实现分区裁剪。这是最高效的数据过滤方式。</li>
<li><strong>示例:</strong>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 查询最近一天的数据，StarRocks 只会扫描对应的分区</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> user_behavior </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> event_time </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token plain"> date_sub</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">now</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">DAY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
<li>
<p><strong>排序键 (Sort Key):</strong></p>
<ul>
<li><strong>目的:</strong> 加速基于排序列前缀的过滤和范围查询。</li>
<li><strong>实践:</strong> 将最高频的等值或范围查询过滤字段放在排序键的最前面。对于高并发的点查场景（如 <code>WHERE user_id = ?</code>），将 <code>user_id</code> 作为排序键的第一列，性能会得到极大提升。</li>
<li><strong>示例:</strong>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- user_id 是排序键的第一列，可以快速定位</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> user_profile </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id </span><span class="token keyword" style="font-style:italic">BIGINT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tag_id </span><span class="token keyword" style="font-style:italic">INT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">user_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> tag_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
<li>
<p><strong>分桶键 (Bucket Key):</strong></p>
<ul>
<li><strong>目的:</strong> 均匀分布数据，避免倾斜。在高并发场景下，它还有<strong>分桶裁剪</strong>的作用。</li>
<li><strong>实践:</strong> 当 <code>WHERE</code> 条件中包含对分桶键的等值过滤时，StarRocks 可以只扫描该 Key 所在的一个分桶（Tablet），极大地减少了扫描范围。因此，对于高并发点查场景，<strong>使用查询的 ID 列作 为分桶键</strong>是绝佳实践。</li>
<li><strong>示例:</strong>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- user_id 同时是排序键和分桶键，查询效率最高</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> orders </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    order_id </span><span class="token keyword" style="font-style:italic">BIGINT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id </span><span class="token keyword" style="font-style:italic">BIGINT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">order_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">DISTRIBUTED</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">HASH</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">order_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> BUCKETS </span><span class="token number" style="color:rgb(247, 140, 108)">32</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 使用 order_id 分桶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 此查询会同时利用主键索引和分桶裁剪</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> orders </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> order_id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">12345</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-主键模型为点查而生">2.2 主键模型：为点查而生<a href="#22-主键模型为点查而生" class="hash-link" aria-label="2.2 主键模型：为点查而生的直接链接" title="2.2 主键模型：为点查而生的直接链接">​</a></h3>
<p>主键模型天然适合高并发的<strong>点查</strong>和<strong>批量更新</strong>场景。</p>
<ul>
<li><strong>优势:</strong> 其底层实现为主键索引，对于 <code>WHERE primary_key = ...</code> 这样的查询，可以实现毫秒级的快速响应。</li>
<li><strong>持久化主键索引 (v3.1+):</strong> 对于超大规模表，开启持久化主键索引 (<code>&quot;enable_persistent_index&quot; = &quot;true&quot;</code>) 可以将索引从内存转移到磁盘（推荐 SSD），在降低巨大内存开销的同时，依然保持极高的点查性能。</li>
<li><strong>行列混存 (Hybrid Table):</strong> 为了将点查性能推向极致，可以为主键模型表开启行列混存。<!-- -->
<ul>
<li><strong>原理:</strong> 在标准的列式存储之外，额外增加一份行式存储。对于 <code>SELECT * FROM ... WHERE pk = ?</code> 这样的点查，系统可以直接从行存中通过一次 I/O 读取整行数据，避免了多次列式 I/O，延迟更低。更多信息请参考行列混存表。</li>
<li><strong>代价:</strong> 会占用更多的存储空间</li>
<li><strong>适用场景:</strong> 对点查延迟有极端要求（如亚毫秒级），且可以接受更高存储成本的场景。</li>
<li><strong>开启方式:</strong> FE开启 <code>ADMIN SET FRONTEND CONFIG (&quot;enable_experimental_rowstore&quot; = &quot;true&quot;);</code>，在建表时通过 <code>PROPERTIES</code> 指定 <code>&quot;storage_type&quot; = &quot;column_with_row&quot;</code>。<!-- -->
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> orders_hybrid </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    order_id </span><span class="token keyword" style="font-style:italic">BIGINT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    user_id </span><span class="token keyword" style="font-style:italic">BIGINT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">order_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">DISTRIBUTED</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">HASH</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">order_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">PROPERTIES </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;storage_type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;column_with_row&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div>
</li>
<li><strong>开启短路读 (Short-circuit Read):</strong> 为了进一步加速行列混存表的点查，推荐开启短路读。<!-- -->
<ul>
<li><strong>原理:</strong> 启用后，对于符合条件的点查，查询会绕过常规的执行引擎，直接通过短路路径扫描行存数据，提供最低的查询延迟。</li>
<li><strong>开启与验证:</strong>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 检查是否开启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SHOW</span><span class="token plain"> VARIABLES </span><span class="token operator" style="color:rgb(137, 221, 255)">LIKE</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;%enable_short_circuit%&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 为会话开启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> enable_short_circuit </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div>
</li>
<li><strong>生效条件:</strong> 查询的 <code>WHERE</code> 子句必须包含所有主键列，且操作符为 <code>=</code> 或 <code>IN</code>。</li>
<li><strong>验证方式:</strong> 查看查询的 <code>EXPLAIN</code> 计划，如果其中包含 <code>Short Circuit Scan: true</code>，则说明短路读已生效。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-物化视图预计算的艺术">3. 物化视图：预计算的艺术<a href="#3-物化视图预计算的艺术" class="hash-link" aria-label="3. 物化视图：预计算的艺术的直接链接" title="3. 物化视图：预计算的艺术的直接链接">​</a></h2>
<p>对于固定的聚合查询模式（如 BI 报表、看板），物化视图是终极加速手段。</p>
<ul>
<li><strong>原理:</strong> 将复杂的聚合、多表 Join 的结果预先计算并存储起来。查询时，StarRocks 会自动改写查询，直接从物化视图中读取结果，将耗时数秒甚至数分钟的复杂查询降至亚秒级。</li>
<li><strong>实践:</strong>
<ol>
<li>识别出业务中最高频、最耗时的聚合查询。</li>
<li>为这些查询模式创建异步物化视图。</li>
<li>分区和分桶策略尽量与基表对齐，以提升刷新效率。</li>
</ol>
</li>
<li><strong>示例：</strong> 假设有一个高频查询是统计每日各城市的产品销量。<!-- -->
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 原始查询 (可能很慢)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> sale_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> city</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> product_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">SUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sale_amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> sales_records</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> sale_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> city</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> product_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 创建物化视图</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> MATERIALIZED </span><span class="token keyword" style="font-style:italic">VIEW</span><span class="token plain"> daily_city_product_sales_mv</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">REFRESH ASYNC EVERY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">HOUR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> sale_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> city</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> product_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">SUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">sale_amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> total_sales</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> sales_records</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> sale_date</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> city</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> product_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div>
<!-- -->创建后，所有符合该模式的查询都会被自动加速，无需修改任何应用代码。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-query-cache缓存查询中间结果">4. Query Cache：缓存查询中间结果<a href="#4-query-cache缓存查询中间结果" class="hash-link" aria-label="4. Query Cache：缓存查询中间结果的直接链接" title="4. Query Cache：缓存查询中间结果的直接链接">​</a></h2>
<p>对于高并发的聚合查询场景，Query Cache 是一项强大的加速功能。它通过在内存中缓存聚合的中间结果，让后续相同或类似的查询能够复用这些结果，从而避免重复的数据扫描和计算。</p>
<ul>
<li>
<p><strong>原理：缓存中间聚合结果</strong>
Query Cache 依赖于 Pipeline 执行引擎的 <strong>Per-Tablet 计算</strong> 模式。</p>
<ul>
<li><strong>Per-Tablet 计算:</strong> 当单个 BE 节点上待访问的 Tablet 数量大于或等于查询的实际并发度时，一个 Pipeline Driver 能够以 Tablet 为单位进行计算。此  时 Query Cache 才会启用。</li>
<li><strong>缓存中间结果:</strong> 在聚合查询的第一阶段，如果 <code>OlapScanNode</code> 和 <code>AggregateNode</code> 在同一个执行片段 (Fragment) 中，<code>AggregateNode</code> 产生的 Per-Tablet 计算结果就会被缓存到内存中。</li>
<li><strong>结果复用:</strong> 当后续相同或类似的聚合查询到达时，StarRocks 可以直接复用这些缓存的中间结果，从而跳过对这部分数据的磁盘读取和重复计算，显著降低查询延迟和资源消耗。</li>
</ul>
</li>
<li>
<p><strong>适用场景与优势</strong></p>
<ul>
<li><strong>高并发聚合查询:</strong> 在大量用户对复杂数据集执行相同或类似聚合查询的场景下（如 BI 看板），优势尤为明显。</li>
<li><strong>数据相对静态:</strong> 与其他缓存一样，它在数据不频繁更新的场景下效果最好。数据写入后，相关缓存会自动失效。</li>
<li><strong>减少 I/O 和计算:</strong> 通过复用中间结果，直接避免了从磁盘读取数据的开销，降低了 CPU 消耗。</li>
</ul>
</li>
<li>
<p><strong>限制与不适用场景</strong></p>
<ul>
<li><strong>Shuffle 操作:</strong> 如果在聚合之前对数据进行了 Shuffle 操作（例如，<code>GROUP BY</code> 的列不是分桶键），则 Query Cache 无法生效。</li>
<li><strong>部分 DISTINCT 查询:</strong> 当 <code>cbo_cte_reuse</code> 开启时，包含 <code>avg(distinct)</code> 或多个 <code>DISTINCT</code> 聚合函数的查询，其执行计划可能会将 <code>OlapScanNode</code> 和 <code>AggregateNode</code> 分离到不同 Fragment 中，导致 Query Cache 不被启用。</li>
<li><strong>高基数列聚合:</strong> 对高基数列进行分组或去重，可能会产生非常大的中间结果。这类查询在运行时会动态绕过 Query Cache。</li>
<li><strong>结果大小限制:</strong> 单个 Tablet 的计算结果如果超过 <code>query_cache_entry_max_bytes</code> 或 <code>query_cache_entry_max_rows</code> 阈值，该查询后续的计算将不再使用 Query Cache，转而使用 Passthrough 机制。</li>
<li><strong>低命中率惩罚:</strong> 在缓存命中率低的场景下，启用 Query Cache 反而会带来额外的性能开销。</li>
</ul>
</li>
<li>
<p><strong>如何使用与配置</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="开启方式">开启方式<a href="#开启方式" class="hash-link" aria-label="开启方式的直接链接" title="开启方式的直接链接">​</a></h4>
<p>Query Cache 默认关闭，可以通过多种方式开启：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 1. 全局开启 (对所有后续会话生效)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">GLOBAL</span><span class="token plain"> enable_query_cache </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 2. 会话级别开启 (仅对当前会话生效)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> enable_query_cache </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 3. SQL 级别开启 (仅对单条 SQL 生效，优先级最高)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*+ SET_VAR(enable_query_cache=true) */</span><span class="token plain"> city</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">SUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">order_amount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> orders </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> create_time </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2023-11-01&#x27;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> city</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="关键配置参数">关键配置参数<a href="#关键配置参数" class="hash-link" aria-label="关键配置参数的直接链接" title="关键配置参数的直接链接">​</a></h4>
<p>可以在 BE 的 <code>be.conf</code> 文件中配置 Query Cache 的行为，或通过 <code>ADMIN SET CONFIG</code> 动态修改。</p>
<ul>
<li><code>query_cache_capacity</code>: BE 节点上用于 Query Cache 的总内存大小，默认 512 MB。</li>
<li><code>query_cache_entry_max_bytes</code>: 单个 Tablet 计算结果可被缓存的最大大小。</li>
<li><code>query_cache_entry_max_rows</code>: 单个 Tablet 计算结果可被缓存的最大行数。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="监控与验证">监控与验证<a href="#监控与验证" class="hash-link" aria-label="监控与验证的直接链接" title="监控与验证的直接链接">​</a></h4>
<p>可以通过多种方式观测 Query Cache 的工作状态和效果。</p>
<ul>
<li>
<p><strong>查询 Profile:</strong> 在查询的 Profile 中，如果 <code>AggregateNode</code> 成功利用了 Query Cache，其下方会展示 <code>CacheOperator</code> 的统计信息，明确显示了缓存的命中情况。</p>
</li>
<li>
<p><strong>Prometheus 指标:</strong> StarRocks 通过 BE 的 metrics 接口暴露了丰富的 Query Cache 指标，可以在 Prometheus 中采集和监控。</p>
<ul>
<li><code>starrocks_be_query_cache_usage</code>: 缓存已使用的容量（字节）。</li>
<li><code>starrocks_be_query_cache_capacity</code>: 缓存总容量（字节）。</li>
<li><code>starrocks_be_query_cache_usage_ratio</code>: 缓存使用率。</li>
<li><code>starrocks_be_query_cache_lookup_count</code>: 查询尝试使用缓存的总次数。</li>
<li><code>starrocks_be_query_cache_hit_count</code>: 缓存命中次数。</li>
<li><code>starrocks_be_query_cache_hit_ratio</code>: 缓存命中率。高命中率是 Query Cache 发挥作用的关键标志。</li>
</ul>
</li>
<li>
<p><strong>BE API 接口:</strong> 可以直接访问 BE 的 HTTP 接口获取更详细的缓存统计信息。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">http://&lt;be_host&gt;:&lt;be_http_port&gt;/api/query_cache/stat</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-架构层面提升吞吐与可用性">5. 架构层面：提升吞吐与可用性<a href="#5-架构层面提升吞吐与可用性" class="hash-link" aria-label="5. 架构层面：提升吞吐与可用性的直接链接" title="5. 架构层面：提升吞吐与可用性的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-fe-负载均衡">5.1 FE 负载均衡<a href="#51-fe-负载均衡" class="hash-link" aria-label="5.1 FE 负载均衡的直接链接" title="5.1 FE 负载均衡的直接链接">​</a></h3>
<p>单个 FE 节点的连接数和查询规划能力是有限的。在高并发场景下，必须部署多个 FE 节点，并通过负载均衡器对外提供服务。</p>
<ul>
<li>
<p><strong>实践:</strong> 在 3 个或更多 FE 节点前架设一个四层负载均衡器（如 Nginx, HAProxy, F5），为 JDBC/MySQL 端口 (9030) 和 HTTP   端口 (8030) 提供统一的虚拟 IP (VIP)。</p>
</li>
<li>
<p><strong>优点:</strong></p>
<ul>
<li><strong>高可用:</strong> 单个 FE 宕机不影响服务。</li>
<li><strong>负载均衡:</strong> 将客户端连接和查询规划的压力均匀分散到所有 FE 节点。</li>
<li><strong>简化配置:</strong> 客户端只需连接 VIP，无需关心后端 FE 拓扑。</li>
</ul>
</li>
<li>
<p><strong>Nginx 配置示例 (TCP 负载均衡):</strong></p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">stream {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    upstream starrocks_fe_mysql {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        least_conn; # 使用最少连接策略</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        server &lt;fe1_ip&gt;:9030;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        server &lt;fe2_ip&gt;:9030;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        server &lt;fe3_ip&gt;:9030;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    server {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        listen 9030; # 暴露给客户端的统一端口</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        proxy_pass starrocks_fe_mysql;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-be-水平扩展">5.2 BE 水平扩展<a href="#52-be-水平扩展" class="hash-link" aria-label="5.2 BE 水平扩展的直接链接" title="5.2 BE 水平扩展的直接链接">​</a></h3>
<p>StarRocks 的计算能力与 BE 节点的总 CPU 核数成正比。当现有集群无法满足 QPS 需求时，最直接有效的方式就是<strong>水平扩展 BE 节点</strong>。增加 BE 节点可以线性地提升集群的整体查询处理能力。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-资源隔离">5.3 资源隔离<a href="#53-资源隔离" class="hash-link" aria-label="5.3 资源隔离的直接链接" title="5.3 资源隔离的直接链接">​</a></h3>
<p>高并发查询通常是资源消耗可预测的短查询。为了避免它们被临时的、重量级的 Ad-hoc 分析查询影响，可以使用资源组进行隔离。</p>
<ul>
<li><strong>实践:</strong> 创建不同的资源组，为高并发业务分配固定的 CPU 和内存资源，确保其查询的稳定性。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="54-关键参数调优设置-pipeline_dop--1">5.4 关键参数调优：设置 <code>pipeline_dop = 1</code><a href="#54-关键参数调优设置-pipeline_dop--1" class="hash-link" aria-label="54-关键参数调优设置-pipeline_dop--1的直接链接" title="54-关键参数调优设置-pipeline_dop--1的直接链接">​</a></h3>
<p>在高并发场景下，核心目标是提升系统总体的吞吐量 (QPS)，而非压榨单个查询的极致性能。默认的 <code>pipeline_dop</code>（通常为 0，即自动设置）会为每个查询分配较多的 CPU 核心，这在并发量高时会导致严重的线程切换开销，反而降低整体吞吐。</p>
<ul>
<li><strong>实践:</strong> 通过 <code>SET GLOBAL</code> 将 <code>pipeline_dop</code> 设置为 <code>1</code>。这会强制每个查询在单个 BE 节点上只使用一个核心执行，极大减少了 CPU 调度开销，使得集群能够稳定处理更高的并发请求。<!-- -->
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- 设置全局 pipeline_dop 为 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">GLOBAL</span><span class="token plain"> pipeline_dop </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre></div></div>
</li>
<li><strong>原理:</strong> 将并行执行的模型切换为串行执行，避免了大量短查询之间的 CPU 资源争抢。虽然单个查询的执行时间可能会有微秒或毫秒级的增加，但系统整体的 QPS 会有数倍的提升。这对于高并发点查或小范围聚合场景是至关重要的优化。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-查询端优化">6. 查询端优化<a href="#6-查询端优化" class="hash-link" aria-label="6. 查询端优化的直接链接" title="6. 查询端优化的直接链接">​</a></h2>
<ul>
<li><strong>使用连接池:</strong> 客户端应用<strong>必须</strong>使用连接池 (Druid, HikariCP) 来管理数据库连接，避免频繁创建和销毁连接带来的巨大开销。</li>
<li><strong>Prepared Statement (预处理语句):</strong> 对于只有 <code>WHERE</code> 条件中的值不同的高频、固定模式 SQL，使用 <code>PreparedStatement</code> 是一个关键的性能优化手段。<!-- -->
<ul>
<li><strong>原理:</strong> 当客户端（如 JDBC）首次发送一个 <code>PreparedStatement</code> 请求时，StarRocks FE 会对这个 SQL 模板进行解析、规划和优化，并将其生成的<strong>执行计划</strong>缓存起来。后续所有使用该 <code>PreparedStatement</code> 的执行请求（<code>EXECUTE</code>），都会直接复用这个缓存的执行计划，只需替换占位符 <code>?</code> 的值即可。</li>
<li><strong>优势:</strong>
<ul>
<li><strong>降低 FE CPU 消耗:</strong> 它完全跳过了 SQL 解析、查询规划和优化的开销，在高 QPS 场景下能显著降低 FE 的 CPU 负载。</li>
<li><strong>降低查询延迟:</strong> 减少了查询生命周期中的多个步骤，使得端到端延迟更低。</li>
<li><strong>防止 SQL 注入:</strong> 提供了更高的安全性。</li>
</ul>
</li>
<li><strong>实践:</strong> 客户端应用<strong>必须</strong>通过 JDBC 的 <code>PreparedStatement</code> 接口来使用此功能。为了真正开启 StarRocks FE 端的执行计划缓存，需要在客户端的 JDBC 连接串中添加 MySQL 驱动的 <code>useServerPrepStmts=true</code> 参数。它对于高并发的点查（如 <code>SELECT ... FROM ... WHERE pk = ?</code>）和固定模式的小范围聚合查询效果尤为显著。<!-- -->
<ul>
<li><strong>JDBC 连接串示例:</strong>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">jdbc:mysql://&lt;fe_ip&gt;:&lt;fe_query_port&gt;/&lt;db_name&gt;?useServerPrepStmts=true</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>使用 Hint/Session 变量:</strong> 对于个别特殊的查询，可以使用 Hint (<code>/*+ SET_VAR(...) */</code>) 来临时调整执行参数（如并行度 <code>pipeline_dop</code>），进行精细化调优，而不影响全局配置。</li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/using_starrocks/real-time-analytics"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">实时分析场景最佳实践</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Monitor"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">运维与监控</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-核心思想减少计算减少-io" class="table-of-contents__link toc-highlight">1. 核心思想：减少计算，减少 I/O</a></li><li><a href="#2-数据建模奠定高性能基石" class="table-of-contents__link toc-highlight">2. 数据建模：奠定高性能基石</a><ul><li><a href="#21-分区分桶与排序键的协同作用" class="table-of-contents__link toc-highlight">2.1 分区、分桶与排序键的协同作用</a></li><li><a href="#22-主键模型为点查而生" class="table-of-contents__link toc-highlight">2.2 主键模型：为点查而生</a></li></ul></li><li><a href="#3-物化视图预计算的艺术" class="table-of-contents__link toc-highlight">3. 物化视图：预计算的艺术</a></li><li><a href="#4-query-cache缓存查询中间结果" class="table-of-contents__link toc-highlight">4. Query Cache：缓存查询中间结果</a></li><li><a href="#5-架构层面提升吞吐与可用性" class="table-of-contents__link toc-highlight">5. 架构层面：提升吞吐与可用性</a><ul><li><a href="#51-fe-负载均衡" class="table-of-contents__link toc-highlight">5.1 FE 负载均衡</a></li><li><a href="#52-be-水平扩展" class="table-of-contents__link toc-highlight">5.2 BE 水平扩展</a></li><li><a href="#53-资源隔离" class="table-of-contents__link toc-highlight">5.3 资源隔离</a></li><li><a href="#54-关键参数调优设置-pipeline_dop--1" class="table-of-contents__link toc-highlight">5.4 关键参数调优：设置 <code>pipeline_dop = 1</code></a></li></ul></li><li><a href="#6-查询端优化" class="table-of-contents__link toc-highlight">6. 查询端优化</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>